<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Web of Things (WoT) Scripting API</title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c-common" class="remove"></script>
    <script class='remove'>
      // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
      var respecConfig = {
        specStatus: "ED",
        shortName: "wot-scripting-api",
        copyrightStart:       2017,
        noLegacyStyle:        true,
        publishDate:          "",
        previousPublishDate:  "",
        previousMaturity:     "",
        edDraftURI:           "https://w3c.github.io/wot-scripting-api/",
        crEnd:                "",
        inlineCSS:            true,
        noIDLIn:              true,
        format:               'markdown',
        editors: [
          { name: "Zoltan Kis", company: "Intel" },
          { name: "Kazuaki Nimura", company: "Fujitsu" },
          { name: "Daniel Peintner", company: "Siemens" },
        ],
        wg:           "Web of Things Working Group",
        wgURI:        "https://www.w3.org/WoT/WG/",
        wgPublicList: "member-wot-wg@w3.org",
        issueBase: "https://www.github.com/w3c/wot-scripting-api/issues/",
        githubAPI: "https://api.github.com/repos/w3c/wot-scripting-api",
        otherLinks: [
          {
            key: "Repository",
            data: [{
                  value: "We are on Github.",
                  href: "https://github.com/w3c/wot-scripting-api"
              }, {
                  value: "File a bug.",
                  href: "https://github.com/w3c/wot-scripting-api/issues"
              }, {
                  value: "Commit history.",
                  href: "https://github.com/w3c/wot-scripting-api/commits/"
              }, {
                  value: "Use cases",
                  href: "https://github.com/w3c/wot-scripting-api/use-cases.html"
              }, {
                  value: "Security and Privacy",
                  href: "https://github.com/w3c/wot-scripting-api/security-privacy.html"
              }, {
                  value: "Rationale",
                  href: "https://w3c.github.io/wot-scripting-api/rationale"
              }, {
                  value: "Primer",
                  href: "https://w3c.github.io/wot-scripting-api/primer"              }
            ]
          },
          {
            key: "Contributors",
            data: [
                {
                  value: "In the github repository",
                  href: "https://github.com/w3c/wot-scripting-api/graphs/contributors"
                }
            ]
          },
        ],
        localBiblio: {
          "WOT-PRACTICES": {
            href:"http://w3c.github.io/wot/current-practices/wot-practices.html",
            title: "Web of Things Current Practices",
            publisher: "W3C",
            date: "6 February 2017"
          },
          "TYPESCRIPT": {
            href:"https://github.com/Microsoft/TypeScript/blob/master/doc/spec.md",
            title: "TypeScript Language Specification",
            publisher: "Microsoft",
            date: "1 October 2012"
          },
          "WEBAPPSEC": {
            href:"https://w3c.github.io/webappsec/specs/powerfulfeatures",
            title: "Secure Contexts",
            publisher: "W3C",
            date: "17 July 2015"
          },
        },
      };
    </script>
  </head>
  <body>

  <section id="abstract">
    <p>
      This specification describes a programming interface to [the Web of Things](http://w3c.github.io/wot/current-practices/wot-practices.html) (<code>WoT</code>), that allows scripts run on a <a>Thing</a> to discover and access other <a>Thing</a>s through a Client API, provide resources characterized by properties, actions and events through a Server API, and access locally attached hardware.
    </p>
  </section>

  <section id="sotd">
    <p>
      Implementers need to be aware that this specification is considered unstable. Vendors interested in implementing this specification before it eventually reaches the Candidate Recommendation phase should subscribe to the [repository](https://github.com/w3c/wot-scripting-api) and take part in the discussions.
    </p>
  </section>

  <section id="conformance">
    <p>
      This document defines conformance criteria that apply to a single product: the <dfn>UA</dfn> (user agent) that implements the interfaces it contains.
    </p>
    <p>
      This specification can be used for implementing the WoT Scripting API in multiple language bindings. Currently ECMAScript and TypeScript definitions are described in this document. For specifying bindings in other languages, extensions of this document may be created later.
    </p>
    <p>
      The user agent (UA) may be implemented in the browser, or in a separate runtime environment, such as [Node.js](https://nodejs.org/en/) or small embedded runtimes such as the [JavaScript Runtime for Zephyr OS](https://www.zephyrproject.org/community/blog/introducing-javascript-runtime-zephyr-os).
    </p>
    <p>
      Implementations that use ECMAScript executed in a browser to implement the APIs defined in this document MUST implement them in a manner consistent with the ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]].
    </p>
    <p>
      Implementations that use TypeScript or ECMAScript in a runtime to implement the APIs defined in this document MUST implement them in a manner consistent with the TypeScript Bindings defined in the TypeScript specification [[!TYPESCRIPT]].
    </p>
    <p>
      This document serves a general description of the WoT Scripting API. Language and runtime specific issues are discussed in separate extensions of this document.
    </p>
  </section>

  <section> <h2>Terminology and conventions</h2>
    <p>
      The following terms are defined in [[!WOT-PRACTICES]]:
    </p>
    <dl>
      <dt><dfn data-lt="Things">Thing</dfn></dt>
      <dd>A physical or virtual entity that represents physicality, such as a device, a group of devices, a room, or a software stack that exposes <a>WoT interface</a>s.</dd>

      <dt><dfn data-lt="TD|TDs|Thing Descriptions">Thing Description</dfn></dt>
      <dd>Structured data describing a physical device or software service (WoT Thing) that includes metadata, links to domain-specific vocabulary, a list of offered interactions, the supported protocol bindings for each interaction, and links to related Things.</dd>

      <dt><dfn>WoT Interface</dfn></dt>
      <dd>Resource-oriented, REST-ful Web interface that allows access to <a>Things</a> exposed over a network using different <a>Protocol Bindings</a>, as defined by <a>Thing Description</a>s.</dd>

      <dt><dfn>Protocol Bindings</dfn></dt>
      <dd>A mapping from operations on the WoT resource model to specific operations of a protocol. Protocol bindings are being defined for HTTP, CoAP, Bluetooth Smart (BLE), MQTT, WebSockets, etc.</dd>

      <dt><dfn>JSON-LD</dfn></dt>
      <dd>A JSON document that is augmented with support for Linked Data by providing an <code>@context</code> property with a defining URI [[!JSON-LD]].</dd>
    </dl>
    <p>
      <dfn data-lt="consume|consume a TD|consuming a TD">Consuming a Thing Description</dfn> means parsing the <a>Thing Description</a> and building a resource model with the use of <a>Protocol Bindings</a> that can be used in a script for accessing and controlling the Thing. A <a>Thing</a> when starts up, consumes its own <a>TD</a>, then it exposes its <a>WoT interface</a> as a server. Note that a script on a <a>Thing</a> may consume other <a>TD</a>s and expose a combined interface of the consumed <a>Things</a>.
    </p>
    <p>
      A <dfn>WoT Runtime</dfn> or <dfn>WR</dfn> is defined as a script execution environment that manages the lifecycle of WoT application scripts, implements a script interpreter, an event loop, a security enforcement point for access management and uses lower-level APIs to provide access to local and remote resources. A <a>WR</a> should be isolated from other execution environments on memory address space, storage address space (file system), network namespace, etc.
    </p>
    <p class="note">
      In this version of the specification, a <a>WR</a> is assumed to run a single script that uses this API to define one or more <a>Things</a> that share a common event loop. Script deployment methods are out of scope of this version. In future versions, running multiple scripts (as modules) may be possible, and script deployment MAY be implemented using a manager <a>Thing</a> whose actions permit script lifecycle management operations.
    </p>
      <p>
       A <a>Thing</a> is represented either as a <a>ConsumedThing</a> (for <a>Things</a> obtained by discovery or retrieve operations) or <a>ExposedThing</a> (for <a>Thing</a>s created with this API inside the <a>WR</a>). All <a>ExposedThing</a>s contained in a <a>WR</a> are serving external requests through the same event loop, and are said to be <dfn>local Things</dfn> to each other. All other <a>Thing</a>s that run in a different <a>WR</a>, even if on the same physical hardware, are said to be <dfn>remote Things</dfn> to each other. Note that there may also be local  <a>ConsumedThing</a> objects as well.
    </p>
    <p>
      The terms <a href="http://www.w3.org/TR/url-1/"><dfn>URL</dfn></a> and
      <a href="https://url.spec.whatwg.org/#concept-url-path">
      <dfn>URL path</dfn></a> are defined in [[!URL]].
    </p>
    <p>
      The following terms are defined in [[!HTML5]] and are used in the context of browser implementations:
      <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">
      <dfn>browsing context</dfn></a>,

      <a href="https://html.spec.whatwg.org/#top-level-browsing-context">
      <dfn>top-level browsing context</dfn></a>,

      <a href="https://html.spec.whatwg.org/multipage/webappapis.html#global-object">
      <dfn>global object</dfn></a>,

      <a href="http://www.w3.org/TR/html5/webappapis.html#incumbent-settings-object">
      <dfn>incumbent settings object</dfn></a>,

      <a href="https://html.spec.whatwg.org/#document">
      <dfn>Document</dfn></a>,

      <a href="http://www.w3.org/TR/2011/WD-html5-20110113/urls.html#document-base-url">
      <dfn>document base URL</dfn></a>,

      <a href="https://html.spec.whatwg.org/#window">
      <dfn>Window</dfn></a>,

      <a href="https://html.spec.whatwg.org/#windowproxy">
      <dfn>WindowProxy</dfn></a>,

      <a href="https://html.spec.whatwg.org/#origin">
      <dfn>origin</dfn></a>,

      <a href="https://html.spec.whatwg.org/#ascii-serialisation-of-an-origin">
      <dfn>ASCII serialized origin</dfn></a>,

      executing algorithms <a href="https://html.spec.whatwg.org/#in-parallel">
      <dfn>in parallel</dfn></a>,

      <a href="https://html.spec.whatwg.org/#queue-a-task">
      <dfn>queue a task</dfn></a>,

      <a href="https://html.spec.whatwg.org/#task-source">
      <dfn>task source</dfn></a>,

      <a href="https://html.spec.whatwg.org/#the-iframe-element">
      <dfn>iframe</dfn></a>,

      <a href="https://html.spec.whatwg.org/#valid-mime-type">
      <dfn>valid MIME type</dfn></a>.
    </p>
    <p>
      A <a>browsing context</a> refers to the environment in which
      <a>Document</a> objects are presented to the user. A given
      <a>browsing context</a> has a single <code><a>WindowProxy</a></code> object,
      but it can have many <code>Document</code> objects, with their associated
      <code><a>Window</a></code> objects. The <a>script execution context</a>
      associated with the <i>browsing context</i> identifies the entity which
      invokes this API, which can be a <i>web app</i>, a <i>web page</i>, or an
      <a>iframe</a>.
    </p>
    <p>
      The term
      <a href="https://w3c.github.io/webappsec/specs/powerfulfeatures/#secure-context">
      <dfn>secure context</dfn></a> is defined in [[!WEBAPPSEC]].
    </p>
    <p>
      <a href="https://tc39.github.io/ecma262/#sec-execution-contexts">
      <dfn>script execution context</dfn></a>,
      <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-promise-objects">
      <dfn>Promise</dfn></a>,
      <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-json-object">
      <dfn>JSON</dfn></a>,
      <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-json.stringify">
      <dfn>JSON.stringify</dfn></a> and
      <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-json.parse">
      <dfn>JSON.parse</dfn></a>
      are defined in [[!ECMASCRIPT]].
    </p>
    <p>
      The algorithms <a href="http://www.w3.org/TR/encoding/#utf-8-encode">
      <dfn>utf-8 encode</dfn></a>, and
      <a href="http://www.w3.org/TR/encoding/#utf-8-decode">
      <dfn>utf-8 decode</dfn></a> are defined in [[!ENCODING]].
    </p>
    <p>
      <dfn>IANA media type</dfn>s (formerly known as MIME types) are defined in
      <a href="http://tools.ietf.org/html/rfc2046">RFC2046</a>.
    </p>
  </section>

  <section id="introduction"> <h2>Introduction</h2>
    <p>
      The overall WoT concepts are described in the [WoT Architecture](https://w3c.github.io/wot-architecture/) document.
      The Web of Things is made of entities (<a>Thing</a>s) that can describe their capabilities in a machine-interpretable format, the <a>Thing Description</a> (TD). By <a>consuming a TD</a>, a client <a>Thing</a> creates a runtime resource model that allows accessing the properties, actions and events exposed by the server <a>Thing</a>. Exposing a <a>Thing</a> requires defining a <a>Thing Description</a> and instantiating a software stack needed to serve requests for accessing the exposed properties, actions and events. This specification describes how to expose and consume <a>Thing</a>s by a script. Support for scripting is optional for WoT devices.
    </p>
    <p class="note">
      Typically scripts are meant to be used on devices able to provide resources (with a <a>WoT interface</a>) for managing (installing, updating, running) scripts, such as bridges or gateways that expose and control simpler devices as WoT <a>Thing</a>s.
    </p>
  </section>

  <section class="informative"> <h3>Use Cases</h3>
    <p>
      The following scripting use cases are covered in this specification:
    </p>
    <ul>
      <li>Discover all <a>Things</a> in the WoT network by sending a broadcast request.</li>
      <li>Discover <a>Things</a> running in the local <a>WoT Runtime</a>.</li>
      <li>Discover nearby <a>Things</a>, for instance by NFC or Bluetooth.</li>
      <li>Discover <a>Things</a> by sending a discovery request to a given registry.</li>
      <li>Discover <a>Thing</a>s by filters defined on <a>Thing Description</a>s</li>
      <li>Discover <a>Thing</a>s by semantic filters.</li>
      <li>Stop or suppress an ongoing discovery process.</li>
      <li>Fetch and <a>consume a TD</a> of a remote <a>Thing</a>.</li>
      <li>On a consumed <a>Thing</a>,
        <ul>
          <li>Get the value of a property or set of properties.</li>
          <li>Set the value of a property or a set of properties.</li>
          <li>Invoke an action.</li>
          <li>
            Observe events.
            <ul>
              <li>Add a listener to an event.</li>
              <li>Remove a listener from an event.</li>
              <li>Remove all listeners.</li>
            </ul>
            Default events are the following:
            <ul>
              <li>A property has changed.</li>
              <li>An action has been invoked.</li>
              <li><a>Thing Description</a> has changed, i.e. properties, events or actions have been defined, removed, or the definition has changed.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Retrieve a thing.</li>
      <li>Create and expose a local <a>Thing</a> based on a <a>Thing Description</a>.</li>
      <li>Programmatically create and expose a local <a>Thing</a>. This may include the following use cases:
        <ul>
          <li>Create a local <a>Thing</a>.</li>
          <li>Add a property definition to the <a>Thing</a>.</li>
          <li>Add an event definition to the <a>Thing</a>.</li>
          <li>Add an action definition to the <a>Thing</a>.</li>
          <li>Attach semantic information to an action</li>
          <li>Attach semantic information to a property</li>
          <li>Attach semantic information to an event</li>
          <li>Emit an event, i.e. notify all listeners subscribed to that event.</li>
          <li>Register handlers for external requests:
            <ul>
              <li>to retrieve a property value;</li>
              <li>to update a property value;</li>
              <li>to run an action: take the parameters from the request, execute the defined action, and return the result;</li>
              <li>to add a listener to an event;</li>
              <li>to remove an event listener.</li>
              <li>to fetch the <a>Thing Description</a>;</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Register the Thing.</li>
      <li>Unregister the Thing.</li>
      <li>Start the exposed <a>Thing</a> in order to process external requests.</li>
      <li>Stop the exposed <a>Thing</a>.</li>
    </ul>
    <p>
      The following use cases are being considered for next versions:
    </p>
    <ul>
      <li>Add, remove and update the definition of a property on a Thing that runs in the same the WoT Runtime.</li>
      <li>Add, remove and update the definition of an action on a Thing that runs in the same the WoT Runtime.</li>
      <li>Add, remove and update the definition of an event on a Thing that runs in the same the WoT Runtime.</li>
    </ul>
  </section>

  <section data-dfn-for="ThingInit"> <h2>WoT Data Representation</h2>
    <p>
      WoT provides a unified representation for data exchange between <a>Things</a>, standardized in the [Wot Things Description](https://w3c.github.io/wot-thing-description/) specification.
      <a>Thing Descriptions</a> are represented as dictionary objects in this API.
    </p>
  </section>

  <section data-dfn-for="WoT">
    <h2>The <dfn>WoT</dfn> interface</h2>
    <p>The WoT object is the main API entry point and it is exposed by an implementation of the <a>WoT Runtime</a>. The <dfn>WoT object</dfn> has no internal state and provides methods for discovering, retrieving, and creating a <a>Thing</a>.
    </p>
    <p class="note">
       Browser implementations SHOULD use a namespace object such as `wot`, and [Node.js](https://nodejs.org/en/)-like runtimes MAY provide the API object through the [`require()`](https://nodejs.org/api/modules.html) or [`import`](http://www.ecma-international.org/ecma-262/6.0/#sec-imports) mechanism.
    </p>
    <pre class="idl">
      // [SecureContext]
      // [NamespaceObject]
      interface WoT {
        Observable&lt;ConsumedThing&gt; discover(optional ThingFilter filter);
        Promise&lt;ConsumedThing&gt; retrieve(USVString url);
        Promise&lt;ExposedThing&gt; createLocalThing(ThingInit init);
      };
    </pre>

    <section> <h3>The <dfn>createLocalThing()</dfn> method</h3>
      <p>
        Returns a [Promise](https://heycam.github.io/webidl/#idl-promise) of a locally created <a>ExposedThing</a> based on the provided initialization paramaters.
      </p>
      <p class="ednote">
        The algorithms for the WoT methods will be specified later.
      </p>

      <section data-dfn-for="ThingInit" >
        <h4>The <dfn>ThingInit</dfn> dictionary</h4>>
        <pre class="idl">
          dictionary ThingInit {
            DOMString name;
            USVString url;
            Dictionary description;
          };
        </pre>
        <p>The <a>ThingInit</a> dictionary contains properties to initialize a <a>Thing</a>:
          <ul>
            <li>The <dfn>name</dfn> attribute represents the user given name of the <a>Thing</a>.</li>
            <li>The <dfn>url</dfn> attribute represents the address of the <a>Thing</a>.</li>
            <li>The <dfn>description</dfn> attribute represents the <a>Thing Description</a> of the <a>Thing</a>.</li>
          </ul>
        </p>
      </section>

    </section>

    <section> <h3> The <dfn>retrieve()</dfn> method</h3>
      <p>
        Accepts an <code>url</code> argument and returns a [Promise](https://heycam.github.io/webidl/#idl-promise) of a <a>ConsumedThing</a>.
      </p>
    </section>

    <section> <h3>The <dfn>discover()</dfn> method</h3>
      <p>
        Starts the discovery process that will provide <code><a>ConsumedThing</a></code> objects that match the optional argument <code><a>ThingFilter</a></code>.
        Returns an [Observable](https://github.com/tc39/proposal-observable) object that can be subscribed and unsubscribed to.
      </p>
      <section data-dfn-for="ThingFilter">
        <h4>The <dfn>ThingFilter</dfn> dictionary</h4>
        <p>
          The <a>ThingFilter</a> dictionary extends <a>ThingInit</a> and represents the constraints for discovering <a>Thing</a>s, such as the discovery method to be used.
        </p>
        <pre class="idl">
          dictionary ThingFilter: ThingInit {
            (DiscoveryType or DOMString) method = "any";
          };
        </pre>
        <p>
          The <dfn>method</dfn> property represents the discovery type that should be used in the discovery process. The possible values are defined by the <code><a>DiscoveryMethod</a></code> enumeration that can be extended by string values defined by solutions (with no guarantee of interoperability).
        </p>
        <p class="ednote">
          The extensibility of <a>DiscoveryMethod</a> by proprietary or private methods is a working assumption until consensus is formed and may be removed later.
        </p>
      </section>

      <section data-dfn-for="DiscoveryMethod">
        <h4>The <dfn>DiscoveryMethod</dfn> enumeration</h4>
        <pre class="idl">
          enum DiscoveryMethod { "any", "local", "nearby", "directory", "broadcast" };
        </pre>
        <p>
          The <a>DiscoveryMethod</a> enumeration represents the discovery type to be used:
          <ul>
            <li><dfn>any</dfn> does not provide any restriction</li>
            <li><dfn>local</dfn> for discovering <a>Things</a> defined in the same device</li>
            <li><dfn>nearby</dfn> for discovering <a>Things</a> nearby the device, e.g. by Bluetooth or NFC</li>
            <li><dfn>directory</dfn> for discovery based on a service provided by a directory or repository of <a>Thing</a>s</li>
            <li><dfn>broadcast</dfn> for an open ended discovery based on sending a request to a broadcast address.</li>
          </ul>
        </p>
      </section>
    </section>

    <section> <h3>Examples</h3>
      <pre class="example" title="Discover Things via registry">
        let discoveryType = { type: "registry", url: "http://wot.registry.org" };
        let subscription = wot.discover(discoveryType).subscribe(
          thing => { console.log("Found Thing " + thing.url); },
          error => { console.log("Discovery finished because an error: " + error.message); },
          () => { console.log("Discovery finished successfully");}
        );
        setTimeout(
          () => { subscription.unsubscribe(); console.log("Discovery timeout"); },
          5000);
      </pre>
      <p class="note">
        Note that canceling a discovery (through unsubscribe) may not be successful in all cases, for instance when discovery is based on open ended broadcast requests. However, once `unsubscribe()` has been called,  implementations MUST suppress further event handling ( i.e. further discoveries and errors) on the Observable. Also, a discovery error may not mean the end of the discovery process. However, in order to respect Observable semantics (error always terminates processing), implementations MUST close or suppress further event handling on the Observable.
      </p>
      <pre class="example" title="Discover Things exposed by local hardware">
        let subscription = wot.discover({ type: "local" }).subscribe(
          thing => { console.log("Found local Thing " + thing.url); },
          error => { console.log("Discovery finished because an error: " + error.message); },
          () => { console.log("Discovery finished successfully");}
        );
      </pre>
      <pre class="example" title="Discover Things exposed nearby, e.g. via Bluetooth">
        let subscription = wot.discover({ type: "nearby", description: {protocol: "BLE4.2"} }).subscribe(
          thing => { console.log("Found nearby Thing " + thing.url); },
          error => { console.log("Discovery finished because an error: " + error.message); },
          () => { console.log("Discovery finished successfully");}
        );
      </pre>
      <pre class="example" title="Discover Things exposed in a proprietary way">
        let subscription = wot.discover({ type: "other", description: { solution: "XYZ123", key: "..."} }).subscribe(
          thing => { console.log("Found Thing " + thing.url); },
          error => { console.log("Discovery finished because an error: " + error.message); },
          () => { console.log("Discovery finished successfully");}
        );
      </pre>
    </section> <!-- Examples -->
  </section> <!-- WoT API -->

  <section> <h2>The Thing Server API</h2>
    <p>
      The <a>ExposedThing</a> interface allows for adding properties, actions, and events to a <a>Thing</a>. Similarly, the afore mentioned interactions can be removed again or handlers can be defined for each request type.
    </p>

    <section data-dfn-for="ExposedThing">
      <h2><dfn>ExposedThing</dfn> interface</h2>
      <pre class="idl">
        interface ExposedThing {
          // define Thing Description modifiers
          ExposedThing addProperty(ThingPropertyInit property);
          ExposedThing removeProperty(DOMString name);
          ExposedThing addAction(ThingActionInit action);
          ExposedThing removeAction(DOMString name);
          ExposedThing addEvent(ThingEventInit event);
          ExposedThing removeEvent(DOMString name);
          // define request handlers
          ExposedThing onRetrieveProperty(RequestHandler handler);
          ExposedThing onUpdateProperty(RequestHandler handler);
          ExposedThing onInvokeAction(RequestHandler handler);
          ExposedThing onObserve(RequestHandler handler);
          // define how to expose and run the Thing
          Promise&lt;void&gt; register(optional USVString directory);
          Promise&lt;void&gt; unregister(optional USVString directory);
          Promise&lt;void&gt; start();
          Promise&lt;void&gt; stop();
          Promise&lt;void&gt; emitEvent(DOMString eventName, any payload);
        };
        ExposedThing implements ConsumedThing;
        callback RequestHandler = any (Request request);
      </pre>

      <section> <h3>The <dfn>addProperty()</dfn> method</h3>
        <p>
          Adds a property defined by the argument and updates the <a>Thing Description</a>.
        </p>
        <section data-dfn-for="ThingPropertyInit">
          <h4><dfn>ThingPropertyInit</dfn> dictionary</h4>
          <pre class="idl">
            dictionary ThingPropertyInit {
              DOMString name;
              boolean configurable = true;
              boolean enumerable = true;
              boolean writable = true;
              sequence&lt;SemanticType&gt; semanticTypes;
              USVString description;
              any value;
            };
          </pre>
          <p>
            Represents the <a>Thing</a> property description.
            <ul>
              <li>The <dfn>name</dfn> attribute represents the name of the property.</li>
              <li>The <dfn>value</dfn> attribute represents the value of the property.</li>
              <li>
                The <dfn>configurable</dfn> attribute defines whether the property can be deleted from the object and whether its properties can be changed. The default value is <code>false</code>.
              </li>
              <li>
                The <dfn>enumerable</dfn> attribute defines whether the property can be listed and iterated. The default value is <code>true</code>.
              </li>
              <li>
                The <dfn>writable</dfn> attribute defines whether the property can be updated. The default value is <code>true</code>.
              </li>
              <li>
                The <dfn>semanticTypes</dfn> attribute represents a list of semantic type annotations (e.g. labels, classifications etc) relevant to the property, represented as <a>SemanticType</a> dictionaries.
              </li>
              <li>
                The <dfn>description</dfn> attribute represents the property description to be added to the <a>Thing Description</a>.
              </li>
            </ul>
          </p>
        </section>
        <section data-dfn-for="SemanticType">
          <h2><dfn>SemanticType</dfn> dictionary</h2>
          <pre class="idl">
            dictionary SemanticType {
              DOMString name;
              USVString context;
            };
          </pre>
          <p>
            Represents a semantic type annotation, containing a name and a context.
            <ul>
              <li>The <dfn>name</dfn> attribute represents the name of the semantic type in the given context.</li>
              <li>The <dfn>context</dfn> attribute represents an URL link to the context of the semantic classification.</li>
            </ul>
          </p>
          <p class="ednote">
            Semantic type examples to be added.
          </p>
        </section>
      </section> <!-- addProperty() -->

      <section> <h3>The <dfn>removeProperty()</dfn> method</h3>
        <p>
          Removes the property specified by the <code>name</code> argument and returns the object.
        </p>
      </section>

      <section> <h3>The <dfn>addAction()</dfn> method</h3>
        <p>
          Adds an action to the <a>Thing</a> object as defined by the <code>action</code> argument of type <a>ThingActionInit</a>.
        </p>
        <section data-dfn-for="ThingActionInit">
          <h2><dfn>ThingActionInit</dfn> dictionary</h2>
          <pre class="idl">
            dictionary ThingActionInit {
              DOMString name;
              Dictionary inputDataDescription;
              Dictionary outputDataDescription;
              sequence&lt;SemanticType&gt; semanticTypes;
              Function action;
            };
        </pre>
        <p>
          The <a>ThingActionInit</a> dictionary describes the arguments and the return value.
          <ul>
            <li>The <dfn>name</dfn> attribute provides the action name.</li>
            <li>The <dfn>action</dfn> attribute provides a function that defines the action.</li>
            <li>The <dfn>inputDataDescription</dfn> attribute provides the description of the input arguments.</li>
            <li>The <dfn>outputDataDescription</dfn> attribute provides the description of the returned data.</li>
            <li>
                The <dfn>semanticTypes</dfn> attribute provides a list of semantic type annotations (e.g. labels, classifications etc) relevant to the action, represented as <a>SemanticType</a> dictionaries.
            </li>
          </ul>
        </p>
        </section>
      </section> <!-- addAction -->

      <section> <h3>The <dfn>removeAction()</dfn> method</h3>
        <p>
          Removes the action specified by the <code>name</code> argument and returns the object.
        </p>
      </section>

      <section> <h3>The <dfn>addEvent()</dfn> method</h3>
        <p>
          Adds an action to the <a>Thing</a> object as defined by the <code>action</code> argument of type <a>ThingActionInit</a>.
        </p>
      </section>

      <section> <h3>The <dfn>removeEvent()</dfn> method</h3>
        <p>
          Removes the event specified by the <code>name</code> argument and returns the object.
        </p>
      </section>

      <section data-dfn-for="Request">
        <h3>The <dfn>Request</dfn> dictionary</h3>
        <pre class="idl">
          dictionary Request {
              RequestType type;
              USVString from;
              DOMString name;
              Dictionary options;
              any data;
          };
        </pre>
        <p>
          Represents an incoming request the <a>ExposedThing</a> is supposed to handle, for instance retrieving and updating properties, invoking actions and observing events (WoT interactions).
          <ul>
            <li>
              The <dfn>type</dfn> attribute represents the type of the request as defined in <a>RequestType</a>.
            </li>
            <li>
              The <dfn>from</dfn> attribute represents the address of the client device issuing the request. The type of the address (URL, UUID or other) is defined by the <a>Thing Description</a>.
            </li>
            <li>
              The <dfn>name</dfn> attribute represents the name of the property to be retrieved or updated, or the name of the invoked action, or the event name to be observed.
            </li>
            <li>
              The <dfn>options</dfn> attribute represents the options relevant to the request (e.g. the format or measurement units for the returned value) as key-value pairs. The exact format is specified by the <a>Thing Description</a>.
            </li>
            <li>
              The <dfn>data</dfn> attribute represents the value of the property, or the input data (arguments) of an action. It is not used for retrieve requests and event requests, only for property update and action invocation requests.
            </li>
          </ul>
        </p>
        <section data-dfn-for="RequestType">
          <h2><dfn>RequestType</dfn> enumeration</h2>
          <pre class="idl">
            enum RequestType { "property", "action", "event", "td" };
          </pre>
          <ul>
            <li>The value "<dfn>property</dfn>" represents requests to retrieve or update a property.</li>
            <li>The value "<dfn>action</dfn>" represents requests to invoke an action.</li>
            <li>The value "<dfn>event</dfn>" represents requests to emit an event.</li>
            <li>
              The value "<dfn>td</dfn>" represents requests to change the <a>Thing Description</a>, i.e. to add, remove or modify properties, actions or events.
              <p class="ednote">
                This functionality is here for the sake of completeness for future versions of the API. Currently there is no corresponding functionality at the <a>ConsumedThing</a> level and it is not guaranteed that a Thing Description could be remotely changed by scripting.
              </p>
            </li>
          </ul>
        </section>
      </section>

      <section data-dfn-for="RequestHandler">
        <h3>The <dfn>RequestHandler</dfn> callback</h3>
        <p>
          Callback function for handling interaction requests. Receives an argument <var>request</var> of type <code><a>Request</a></code> and should return an object or value that is used by protocol bindings to reply to the request. The returned type is defined by the <a>Thing Description</a>.
        </p>
      </section>

      <section> <h3>The <dfn>onRetrieveProperty()</dfn> method</h3>
        <p>
          Registers the handler function for property retrieve requests received for the <a>Thing</a>, as defined by the <code>handler</code> property of type <code><a>RequestHandler</a></code>. The handler will receive an argument <var>request</var> of type <code><a>Request</a></code> where at least <var>request.name</var> is defined and represents the name of the property to be retrieved.
        </p>
      </section>

      <section> <h3>The <dfn>onUpdateProperty()</dfn> method</h3>
        <p>
          Defines the handler function for property update requests received for the <a>Thing</a>, as defined by the <code>handler</code> property of type <code><a>RequestHandler</a></code>. The handler will receive an argument <var>request</var> of type <code><a>Request</a></code> where <var>request.name</var> defines the name of the property to be retrieved and <var>request.data</var> defines the new value of the property.
        </p>
      </section>

      <section> <h3>The <dfn>onInvokeAction()</dfn> method</h3>
        <p>
          Defines the handler function for action invocation requests received for the <a>Thing</a>, as defined by the <code>handler</code> property of type <code><a>RequestHandler</a></code>.  The handler will receive an argument <var>request</var> of type <code><a>Request</a></code> where <var>request.name</var> defines the name of the action to be invoked and <var>request.data</var> defines the input arguments for the action as defined by the <a>Thing Description</a>.
        </p>
      </section>

      <section> <h3>The <dfn>onObserve()</dfn> method</h3>
        <p>
          Defines the handler function for observe requests received for the <a>Thing</a>, as defined by the <code>handler</code> property of type <code><a>RequestHandler</a></code>. The handler will receive an argument <var>request</var> of type <code><a>Request</a></code> where
          <ul>
            <li>
              <var>request.name</var> defines the name of the property or action or event to be observed.
            </li>
            <li>
              <var>request.options.observeType</var> is of type <a>RequestType</a> and defines whether a property change or action invocation or event emitting is observed, or the changes to the <a>Thing Description </a> are observed.
            </li>
            <li>
              <var>request.options.subscribe</var> is <code>true</code> if subscription is turned or kept being turned on, and it is <code>false</code> when subscription is turned off.
            </li>
          </ul>
        </p>
      </section> <!-- onObserve() -->

      <section> <h3>The <dfn>register()</dfn> method</h3>
        <p>
          Generates the <a>Thing Description</a> given the properties, actions and events defined for this object. If a <code>directory</code> argument is given, make a request to register the <a>Thing Description</a> with the given WoT repository by invoking its <code>register</code> action.
        </p>
      </section>

      <section> <h3>The <dfn>unregister()</dfn> method</h3>
        <p>
          If a <code>directory</code> argument is given, make a request to unregister the <a>Thing Description</a> with the given WoT repository by invoking its <code>unregister</code> action. Then, and in the case no arguments were provided to this function, stop the <a>Thing</a> and remove the <a>Thing Description</a>.
        </p>
      </section>

      <section> <h3>The <dfn>start()</dfn> method</h3>
        <p>
          Start serving external requests for the <a>Thing</a>.
        </p>
      </section>

      <section> <h3>The <dfn>stop()</dfn> method</h3>
        <p>
          Stop serving external requests for the <a>Thing</a>.
        </p>
      </section>

      <section> <h3>The <dfn>emitEvent()</dfn> method</h3>
        <p>
          Emits an the event initialized with the event name specified by the <code>eventName</code> argument and data specified by the <code>payload</code> argument.
        </p>
        <p class="ednote">
          This method in't actually needed to be exposed by the <a>ExposedThing</a> object since it is usually provided by the runtime.
        </p>
      </section>

    </section>

    <section data-dfn-for="ThingEventInit">
      <h2><dfn>ThingEventInit</dfn> dictionary</h2>
      <pre class="idl">
        dictionary ThingEventInit {
          DOMString name;
          sequence&lt;SemanticType&gt; semanticTypes;
          Dictionary outputDataDescription;
        };
      </pre>
      <ul>
        <li>The <dfn>name</dfn> attribute ...</li>
        <li>The <dfn>semanticTypes</dfn> attribute ...</li>
        <li>The <dfn>outputDataDescription</dfn> attribute ...</li>
      </ul>
    </section>

    <section>
      <h2>Examples</h2>
      <p>
        Below some <code><a>ExposedThing</a></code> interface examples are given.
      </p>

      <pre class="example highlight" title="Create a new blank exposed Thing">
        WoT.createLocalThing(thingDescription)
          .then(function(thing) {
            // manually add properties, actions, and events
            thing.addProperty({
              name: "temperature",
              value: "0",
              writable: false
              // use default values for the rest
            }).addEvent({
              name: "onchange",
              outputDataDescription: {
                type: "float32"
              }
            }).addAction({
              name: "reset",
              action: () => { this.temperature = 0; }
            })
            // add server functionality
            .onRetrieveProperty( request => {
              console.log("Handling read request");
              return this.temperature;
            }).onObserve( request => {
              console.log("Handling observe request");
              // add listener identified by request.from
            }).onInvokeAction( request => {
              console.log("Handling action request");
            }).start();
          });
      </pre>

      <pre class="example highlight" title="Create a new exposed Thing from a TD URI">
        let thingDescription = {
          name: "mySensor",
          uri: "http://myregistry.org/mySensor/description"
        };
        WoT.createLocalThing(thingDescription)
          .then(function(thing) {
            // properties, actions and events are added based on the TD
            console.log("created " + thing.name });
            // now add the requests handlers
            thing.onRetrieveProperty(function(request) {
                console.log("Sending property '" + request.property + "' to " + request.from);
            }).onUpdateProperty(function(request) {
                console.log("Updating property '" + request.property + "' by " + request.from);
            }).onObserve(function(request) {
                console.log("Adding listener " + request.from);
                console.log("Observing " + request.type + " " + request.name +
                    (request.subscribe? " recursively" : ""));
            }).start().then(function() {
               console.log("Thing started serving requests");
            });
          })
      </pre>

      <pre class="example highlight" title="Create a new exposed Thing from a Thing Description">
        let thingDescription = {
          name: "mySensor",
          description: {
            "@context": [
              "http://w3c.github.io/wot/w3c-wot-td-context.jsonld",
              "http://w3c.github.io/wot/w3c-wot-common-context.jsonld",
            ],
            "@type": [ "Thing" ],
            "interaction": [
              // ...
            ]
            // ...
          }
        };
        WoT.createLocalThing(thingDescription)
          .then(function(thing) {
            // properties, actions and events are added based on the TD
            // ...
          });
      </pre>
    </section> <!-- Examples -->
  </section> <!-- The Thing Server API -->

  <section> <h2>The Thing Client API</h2>
    <p>The <a>ConsumedThing</a> interface is basically for sending requests to servers in order to retrieve or update properties, invoke actions, and observe properties, actions and events.</p>

    <section data-dfn-for="ConsumedThing">
      <h2><dfn>ConsumedThing</dfn> interface</h2>
      <pre class="idl">
        interface ConsumedThing {
          readonly attribute DOMString name;
          readonly attribute USVString url;
          readonly attribute Dictionary description;
          Promise&lt;any&gt; invokeAction(DOMString name, sequence&lt;any&gt; parameters);
          Promise&lt;void&gt; setProperty(DOMString name, any value);
          Promise&lt;any&gt; getProperty(DOMString name);
          ConsumedThing addListener(DOMString eventName, ThingEventListener listener);
          ConsumedThing removeListener(DOMString eventName, ThingEventListener listener);
          ConsumedThing removeAllListeners(DOMString eventName);
        };
        callback ThingEventListener = void (Event event);
        typedef (ThingPropertyInit or ThingActionInit or ThingEventInit) TDChangeData;
      </pre>
      <ul>
        <li>The <dfn>name</dfn> attribute ...</li>
        <li>The <dfn>url</dfn> attribute ...</li>
        <li>The <dfn>description</dfn> attribute ...</li>
        <li>The <dfn>invokeAction()</dfn> method ...</li>
        <li>The <dfn>setProperty()</dfn> method ...</li>
        <li>The <dfn>getProperty()</dfn> method ...</li>
        <li>The <dfn>addListener()</dfn> method ...</li>
        <li>The <dfn>removeListener()</dfn> method ...</li>
        <li>The <dfn>removeAllListeners()</dfn> method ...</li>
      </ul>
    </section>

    <section data-dfn-for="ThingEventListener">
      <h2><dfn>ThingEventListener</dfn> callback</h2>
      <p class="ednote">Add adequate description.</p>
    </section>

    <section data-dfn-for="TDChangeData">
      <h2><dfn>TDChangeData</dfn> typedef</h2>
      <p class="ednote">Add adequate description.</p>
    </section>

    <section data-dfn-for="PropertyChangeEvent">
      <h2><dfn>PropertyChangeEvent</dfn> interface</h2>
      <pre class="idl">
        [Constructor(PropertyChangeEventInit init)]
        interface PropertyChangeEvent: Event {
            readonly attribute PropertyChangeEventInit data;
        };
      </pre>
      <ul>
        <li>The <dfn>data</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="ActionInvocationEvent">
      <h2><dfn>ActionInvocationEvent</dfn> interface</h2>
      <pre class="idl">
        [Constructor(ActionInvocationEventInit init)]
        interface ActionInvocationEvent: Event {
            readonly attribute ActionInvocationEventInit data;
        };
      </pre>
      <ul>
        <li>The <dfn>data</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="ThingDescriptionChangeEvent">
      <h2><dfn>ThingDescriptionChangeEvent</dfn> interface</h2>
      <pre class="idl">
        [Constructor(ThingDescriptionChangeEventInit init)]
        interface ThingDescriptionChangeEvent: Event {
            readonly attribute ThingDescriptionChangeEventInit data;
        };
      </pre>
      <ul>
        <li>The <dfn>data</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="PropertyChangeEventInit">
      <h2><dfn>PropertyChangeEventInit</dfn> dictionary</h2>
      <pre class="idl">
        dictionary PropertyChangeEventInit {
            DOMString name;
            any value;
            any oldValue;
        };
      </pre>
      <ul>
        <li>The <dfn>name</dfn> attribute ...</li>
        <li>The <dfn>value</dfn> attribute ...</li>
        <li>The <dfn>oldValue</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="ActionInvocationEventInit">
      <h2><dfn>ActionInvocationEventInit</dfn> dictionary</h2>
      <pre class="idl">
        dictionary ActionInvocationEventInit {
            DOMString actionName;
            any returnValue;
        };
      </pre>
      <ul>
        <li>The <dfn>actionName</dfn> attribute ...</li>
        <li>The <dfn>returnValue</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="ThingDescriptionChangeEventInit">
      <h2><dfn>ThingDescriptionChangeEventInit</dfn> dictionary</h2>
      <pre class="idl">
        dictionary ThingDescriptionChangeEventInit {
            TDChangeType type;
            TDChangeMethod method;
            DOMString name;
            TDChangeData data;
        };
      </pre>
      <ul>
        <li>The <dfn>type</dfn> attribute ...</li>
        <li>The <dfn>method</dfn> attribute ...</li>
        <li>The <dfn>name</dfn> attribute ...</li>
        <li>The <dfn>data</dfn> attribute ...</li>
      </ul>
    </section>

    <section data-dfn-for="TDChangeMethod">
      <h2><dfn>TDChangeMethod</dfn> enumeration</h2>
      <pre class="idl">
    enum TDChangeMethod { "add", "remove", "change" };
      </pre>
      <ul>
        <li><dfn>add</dfn> ...</li>
        <li><dfn>remove</dfn> ...</li>
        <li><dfn>change</dfn> ...</li>
      </ul>
    </section>

    <section data-dfn-for="TDChangeType">
      <h2><dfn>TDChangeType</dfn> enumeration</h2>
      <pre class="idl">
        enum TDChangeType { "property", "action", "event" };
        typedef (ThingPropertyInit or ThingActionInit or ThingEventInit) TDChangeData;
      </pre>
      <ul>
        <li><dfn>property</dfn> ...</li>
        <li><dfn>action</dfn> ...</li>
        <li><dfn>event</dfn> ...</li>
      </ul>
    </section>

    <section>
      <h2>Examples</h2>
      <p>
        Below a <code><a>ConsumedThing</a></code> interface example is given.
      </p>
      <pre class="example" title="Consume a Things via retrieve">
        wot.retrieve("http://myregistry.org/mySensor").then(
          error => { console.log("Discovery finished because an error: " + error.message); }
          thing => {
            console.log("Thing " + thing.name + " has been consumed.");
            console.log("{ " + JSON.serialize(thing) + " }");
            thing.addListener("onchange", function(event) {
                if (event instanceof PropertyChangeEvent) {
                    console.log("Property " + event.name + " has changed to " + event.value);
                }
            }).invokeAction("startMeasurement", ["Celsius"]);
          },
        );
      </pre>
    </section> <!-- Examples -->
  </section> <!-- Thing Client API -->

  <section> <h2 id="security">Security and Privacy</h2>
    <p class="ednote">[DP] The security task force might want to check this section.</p>
    <p>
      The trust model, attacker model, threat model and possible mitigation
      proposals for the WoT Scripting API are presented in the WoT Security and Privacy document.
      This section presents the chosen security and privacy model through normative requirements to implementations.
    </p>

    <section> <h3>Chain of Trust</h3>
      <p>
        Things discoverable and accessible in a WoT network SHOULD be identified and authenticated.
      </p>
      <p>
        The integrity of WoT communication SHOULD be ensured by implementations.
      </p>
    </section>

    <section> <h3>Threat Model</h3>
      <p>
      The main threats are summarized in the WoT Security and Privacy document.
      </p>
      <p>
        In this specification the following threats are considered of the highest priority:
      </p>
      <ul>
        <li>
          Unauthorized gathering of user-sensitive information.
        </li>
        <li>
          Vulnerability of the underlying protocols.
        </li>
        <li>
          Protect the integrity of <a>Thing</a>s and <a>Thing Description</a>s.
        </li>
      </ul>
    </section>

    <section> <h3>Security Mechanisms</h3>
      <section> <h4>Identification, Authentication, Authorization</h4>
      </section>

      <section> <h4>Transport-level security</h4>
      </section>

      <section> <h4>Application-level security</h4>
      </section>
    </section>

    <section class="informative"> <h3>Security policies</h3>
      <p>
        This section summarizes the security policies which are specified as
        normative requirements in the respective algorithms of this
        specification.
      </p>
    </section>
  </section>

  <section class="appendix" id="Changes"><h2>Changes</h2>
    <p>
      The following is a list of major changes to the document. For a complete list of changes, see the [github change log](https://github.com/w3c/wot-scripting-api/commits/master). You can also view the [recently closed bugs](https://github.com/w3c/wot-scripting-api/issues?page=1&amp;state=closed).
    </p>
  </section>

  <section> <h3 class="appendix" id="openissues">Open issues</h3>
    <p>
      The following problems are being discussed and need most attention:
    </p>
      <ul>
        <li> Retrieving information from Thing Description (https://github.com/w3c/wot-scripting-api/issues/38) </li>
        <li> Script management and runtime related issues (https://github.com/w3c/wot-scripting-api/issues/) </li>
      </ul>
  </section>

  <section> <h2>Acknowledgements</h2>
    <p>
      Special thanks to former editor Johannes Hund for developing this specification. Also, the editors would like to thank Dave Raggett, Matthias Kovatsch, Michael Koster and Michael McCool for their comments and guidance.
    </p>
  </section>

  </body>
</html>
